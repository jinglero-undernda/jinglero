# BUG_0007 – Audit all existing relationships to validate correct direction

## Metadata

- **Status**: `resolved`
- **Last Updated**: 2025-11-18
- **Category**: `backend`, `data-quality`
- **Severity**: `high`
- **Environment**: Neo4j database (all environments)
- **Related Commits / PRs**: _TBD_
- **Related Bugs**: BUG_0006 (Relationship creation creates wrong direction for versiona)

## Description

A previous bug (BUG_0006) identified that buggy code may have been creating relationships in the Neo4j database in the wrong direction. Specifically, `VERSIONA` relationships were being created as `(Cancion)-[VERSIONA]->(Jingle)` instead of the correct `(Jingle)-[VERSIONA]->(Cancion)`.

This bug may have affected other relationship types as well, and there may be existing relationships in the database that were created with incorrect direction. This requires a systematic audit of all relationships in the database to:

1. Identify relationships created in the wrong direction
2. Fix incorrect relationships by either:
   - Deleting the wrong-direction relationship and creating the correct one (if no correct one exists)
   - Deleting the wrong-direction relationship (if a correct one already exists)
3. Establish a data quality standard approach for future audits

## Root Cause

**Primary Cause**: Buggy relationship creation logic in `RelatedEntities.tsx` (see BUG_0006) that incorrectly determined start/end nodes for certain relationship types.

**Potential Impact**:

- Relationships may have been created in the wrong direction across multiple relationship types
- The bug may have existed for an extended period, affecting many relationships
- Some relationships may have both correct and incorrect versions (duplicates)

**Affected Relationship Types** (from schema):

1. `APPEARS_IN`: `(Jingle)-[APPEARS_IN]->(Fabrica)` ✅ (likely unaffected, but should verify)
2. `JINGLERO_DE`: `(Artista)-[JINGLERO_DE]->(Jingle)` ⚠️ (should audit)
3. `AUTOR_DE`: `(Artista)-[AUTOR_DE]->(Cancion)` ⚠️ (should audit)
4. `VERSIONA`: `(Jingle)-[VERSIONA]->(Cancion)` ❌ **CONFIRMED BUGGY** (see BUG_0006)
5. `TAGGED_WITH`: `(Jingle)-[TAGGED_WITH]->(Tematica)` ⚠️ (should audit)
6. `SOY_YO`: `(Usuario)-[SOY_YO]->(Artista)` ⚠️ (should audit)
7. `REACCIONA_A`: `(Usuario)-[REACCIONA_A]->(Jingle)` ⚠️ (should audit)

## Resolution

**Status**: `resolved` - Audit and fix scripts created and executed successfully on 2025-11-18

### Solution Plan

#### Phase 1: Audit Script Development

Create a comprehensive audit script that:

1. **Validates Entity IDs**:

   - For each node in every relationship, verify the ID format matches one of the 6 entity types:
     - `a` prefix (9 chars): Artista
     - `c` prefix (9 chars): Cancion
     - `j` prefix (9 chars): Jingle
     - `t` prefix (9 chars): Tematica
     - `u` prefix (9 chars): Usuario
     - 11 chars (no prefix): Fabrica
   - Flag as error any node ID that doesn't fit these formats

2. **Validates Relationship Direction**:

   - For each relationship type, query all relationships
   - For each relationship, identify the start and end node types from their IDs
   - Compare against the schema definition to determine if direction is correct
   - Generate a report of all incorrect relationships

3. **Identifies Duplicates**:

   - Detect cases where both correct and incorrect direction relationships exist between the same nodes
   - Flag these for special handling (delete wrong, keep correct)

4. **Generates Audit Report**:
   - Summary statistics (total relationships, correct, incorrect, duplicates)
   - Detailed list of incorrect relationships with:
     - Relationship type
     - Start node (ID, type, label)
     - End node (ID, type, label)
     - Current direction (wrong)
     - Expected direction (correct)
     - Whether duplicate exists
     - Relationship properties (to preserve on fix)

#### Phase 2: Fix Script Development

Create a fix script that:

1. **Dry-run Mode**:

   - Simulate all fixes without making changes
   - Generate detailed report of what would be changed
   - Allow review before execution

2. **Fix Execution**:

   - For relationships with wrong direction only:
     - Delete the wrong-direction relationship
     - Create the correct-direction relationship with same properties
   - For relationships with both wrong and correct:
     - Delete only the wrong-direction relationship
     - Preserve the correct one
   - Preserve all relationship properties (status, createdAt, etc.)

3. **Validation**:
   - After fixes, re-run audit to confirm all relationships are correct
   - Verify no data loss (relationship count should match or decrease only by duplicates)

#### Phase 3: Data Quality Standard

Establish this audit/fix script as part of a future data quality standard approach:

1. **Script Location**: `backend/src/server/db/quality/audit-relationships.ts`
2. **Documentation**: Include in data quality documentation
3. **Scheduled Runs**: Consider periodic audits (monthly/quarterly)
4. **Integration**: Can be run manually or as part of CI/CD pipeline

### Implementation Details

#### Schema Reference

The canonical relationship schema is defined in:

- `backend/src/server/db/schema/schema.ts` (lines 189-259)
- `frontend/src/components/admin/EntityEdit.tsx` (lines 12-20) - `RELATIONSHIP_SCHEMA`

**Correct Relationship Directions** (from schema):

```typescript
const RELATIONSHIP_SCHEMA = {
  appears_in: { start: "jingles", end: "fabricas" }, // (Jingle)-[APPEARS_IN]->(Fabrica)
  jinglero_de: { start: "artistas", end: "jingles" }, // (Artista)-[JINGLERO_DE]->(Jingle)
  autor_de: { start: "artistas", end: "canciones" }, // (Artista)-[AUTOR_DE]->(Cancion)
  versiona: { start: "jingles", end: "canciones" }, // (Jingle)-[VERSIONA]->(Cancion)
  tagged_with: { start: "jingles", end: "tematicas" }, // (Jingle)-[TAGGED_WITH]->(Tematica)
  soy_yo: { start: "usuarios", end: "artistas" }, // (Usuario)-[SOY_YO]->(Artista)
  reacciona_a: { start: "usuarios", end: "jingles" }, // (Usuario)-[REACCIONA_A]->(Jingle)
};
```

#### Entity ID Format Detection

Use the existing utility function pattern from:

- `frontend/src/lib/utils/entityTypeUtils.ts` - `getEntityTypeFromId()`

**ID Format Rules**:

- 9 characters with prefix: `{prefix}{8-alphanumeric}` where prefix is `a`, `c`, `j`, `t`, or `u`
- 11 characters: Fabrica (YouTube video ID)
- Any other format: **ERROR** - flag in audit report

#### Script Structure

```
backend/src/server/db/quality/
├── audit-relationships.ts      # Main audit and fix script
├── relationship-schema.ts      # Schema definitions (shared with frontend)
└── README.md                    # Documentation for data quality scripts
```

**Script Interface**:

```typescript
interface AuditOptions {
  dryRun?: boolean; // Default: true (safe default)
  relationshipTypes?: string[]; // Optional: audit specific types only
  fix?: boolean; // Default: false (audit only)
}

interface AuditResult {
  summary: {
    totalRelationships: number;
    correctRelationships: number;
    incorrectRelationships: number;
    duplicateRelationships: number;
    invalidNodeIds: number;
  };
  incorrect: Array<{
    relType: string;
    startNode: { id: string; type: string; label: string };
    endNode: { id: string; type: string; label: string };
    properties: Record<string, any>;
    hasDuplicate: boolean;
  }>;
  invalidIds: Array<{
    nodeId: string;
    relationshipType: string;
    position: "start" | "end";
    error: string;
  }>;
}
```

#### Neo4j Query Strategy

**Audit Query Pattern**:

```cypher
// For each relationship type, get all relationships with node info
MATCH (start)-[r:RELATIONSHIP_TYPE]->(end)
RETURN
  type(r) as relType,
  start.id as startId,
  labels(start) as startLabels,
  end.id as endId,
  labels(end) as endLabels,
  properties(r) as relProperties
```

**Duplicate Detection**:

```cypher
// Check if reverse relationship exists
MATCH (a)-[r1:RELATIONSHIP_TYPE]->(b)
OPTIONAL MATCH (b)-[r2:RELATIONSHIP_TYPE]->(a)
RETURN
  a.id as nodeA,
  b.id as nodeB,
  r1 IS NOT NULL as forwardExists,
  r2 IS NOT NULL as reverseExists
WHERE forwardExists AND reverseExists
```

**Fix Query Pattern**:

```cypher
// Delete wrong relationship and create correct one (preserve properties)
MATCH (wrongStart)-[r:RELATIONSHIP_TYPE]->(wrongEnd)
WHERE wrongStart.id = $wrongStartId AND wrongEnd.id = $wrongEndId
WITH r, properties(r) as props
DELETE r
CREATE (correctStart)-[newR:RELATIONSHIP_TYPE]->(correctEnd)
SET newR = props
```

### Testing Strategy

1. **Test on Development/Staging First**:

   - Run audit script in dry-run mode
   - Review all flagged relationships
   - Run fix script in dry-run mode
   - Verify fix script output matches expectations
   - Execute fix script on staging
   - Re-run audit to confirm fixes

2. **Production Execution**:
   - Backup database before execution
   - Run audit script (dry-run)
   - Review results with team
   - Run fix script (dry-run)
   - Review fix plan
   - Execute fix script
   - Re-run audit to confirm
   - Monitor application for any issues

### Follow-up Tasks

1. ✅ Fix root cause in `RelatedEntities.tsx` (see BUG_0006 resolution)
2. ✅ Create audit script (`backend/src/server/db/quality/audit-relationships.ts`)
3. ✅ Create fix script (`backend/src/server/db/quality/fix-relationships.ts`)
4. ✅ Create CLI interface (`backend/src/server/db/quality/audit-relationships-cli.ts`)
5. ✅ Create schema definitions (`backend/src/server/db/quality/relationship-schema.ts`)
6. ✅ Create ID validator (`backend/src/server/db/quality/entity-id-validator.ts`)
7. ✅ Create documentation (`backend/src/server/db/quality/README.md`)
8. ✅ Test on production database
9. ✅ Execute fixes on production database
10. ✅ Document as data quality standard
11. ⏳ Consider scheduled periodic audits

### Execution Results (2025-11-18)

**Initial Audit Results**:

- Total relationships: 148
- Correct: 140
- Incorrect: 8
- Duplicates: 5
- Invalid IDs: 0

**Issues Found**:

1. `APPEARS_IN`: 2 incorrect relationships (1 duplicate, 1 to fix)
2. `AUTOR_DE`: 1 invalid relationship (pointed to Jingle instead of Cancion - manually deleted)
3. `VERSIONA`: 1 incorrect relationship (BUG_0006 issue - fixed)
4. `TAGGED_WITH`: 4 incorrect relationships (all had duplicates)

**Fixes Applied**:

- Deleted 5 wrong-direction relationships (all had correct duplicates)
- Fixed 2 relationship directions (APPEARS_IN and VERSIONA) with properties preserved
- Manually deleted 1 invalid AUTOR_DE relationship

**Final Audit Results**:

- Total relationships: 142
- Correct: 142 (100%)
- Incorrect: 0
- Duplicates: 0
- Invalid IDs: 0

✅ **All relationships are now correct!**

### Scripts Created

All scripts are located in `backend/src/server/db/quality/`:

- `relationship-schema.ts`: Canonical relationship direction definitions
- `entity-id-validator.ts`: Entity ID format validation utilities
- `audit-relationships.ts`: Core audit logic
- `fix-relationships.ts`: Core fix logic
- `audit-relationships-cli.ts`: Command-line interface
- `README.md`: Comprehensive documentation

**npm Scripts Added**:

- `npm run db:audit-relationships`: Run audit (dry-run)
- `npm run db:fix-relationships`: Run audit and fix (executes changes)

## Related Files

- `backend/src/server/db/schema/schema.ts`

  - Search for: `Relationships:` (line 189)
  - Contains canonical relationship direction definitions for all 7 relationship types
  - Lines 189-259: Complete relationship schema documentation

- `frontend/src/components/admin/EntityEdit.tsx`

  - Search for: `RELATIONSHIP_SCHEMA` (line 12)
  - Lines 12-20: Relationship schema mapping (should match backend schema)

- `frontend/src/components/common/RelatedEntities.tsx`

  - Search for: `handleCreateRelationship` (line ~630)
  - Lines 630-633: Buggy `versiona` relationship creation logic (see BUG_0006)
  - This is the root cause that may have created wrong-direction relationships

- `frontend/src/lib/utils/entityTypeUtils.ts`

  - Search for: `getEntityTypeFromId` (line 183)
  - Lines 183-209: Function to identify entity type from ID format
  - Can be used as reference for ID validation logic in audit script

- `docs/debugLogs/BUG_0006.md`

  - Related bug that identified the relationship direction issue
  - Contains details about the buggy code and proposed fix

- `backend/src/server/db/migration/` (existing migration scripts)
  - Reference for script structure and patterns
  - `migrate-entity-ids.ts`: Example of database migration script
  - `pre-migration-audit.ts`: Example of audit script pattern

## Related Code

### Schema Definition (Canonical)

From `backend/src/server/db/schema/schema.ts`:

```typescript
// Relationships with correct directions:
1. APPEARS_IN:   (Jingle)-[APPEARS_IN]->(Fabrica)
2. JINGLERO_DE:  (Artista)-[JINGLERO_DE]->(Jingle)
3. AUTOR_DE:     (Artista)-[AUTOR_DE]->(Cancion)
4. VERSIONA:     (Jingle)-[VERSIONA]->(Cancion)      // ❌ Known to be buggy
5. TAGGED_WITH:  (Jingle)-[TAGGED_WITH]->(Tematica)
6. SOY_YO:       (Usuario)-[SOY_YO]->(Artista)
7. REACCIONA_A:  (Usuario)-[REACCIONA_A]->(Jingle)
```

### Entity ID Format Detection

From `frontend/src/lib/utils/entityTypeUtils.ts`:

```typescript
// ID Format Rules:
// - 9 chars with prefix: {a|c|j|t|u}{8-alphanumeric} → Artista|Cancion|Jingle|Tematica|Usuario
// - 11 chars: Fabrica (YouTube video ID)
// - Any other format: ERROR

const NEW_ID_PREFIX_MAP: Record<string, EntityType> = {
  j: "jingle",
  c: "cancion",
  a: "artista",
  t: "tematica",
  // Note: 'u' prefix exists for Usuario but not in this map
};
```

### Buggy Relationship Creation (Root Cause)

From `frontend/src/components/common/RelatedEntities.tsx` (BUG_0006):

```typescript
// ❌ BUGGY CODE (lines 630-633):
} else if (relType === 'versiona') {
  // Jingle -> Cancion
  startId = rel.entityType === 'cancion' ? selectedEntity.id : entity.id;
  endId = rel.entityType === 'cancion' ? entity.id : selectedEntity.id;
}
// This creates (Cancion)-[VERSIONA]->(Jingle) when it should be (Jingle)-[VERSIONA]->(Cancion)
```

## Notes

- ✅ Audit and fix scripts successfully created and executed
- ✅ All relationships validated and corrected
- ✅ Scripts designed to be reusable for future data quality checks
- ✅ Relationship properties preserved during fixes (status, createdAt, etc.)
- ⚠️ Consider adding relationship direction validation to the relationship creation API to prevent future issues
- ⚠️ Special attention needed for relationships with properties that might be direction-dependent (e.g., `APPEARS_IN.order`)
- ✅ Scripts can be run periodically via `npm run db:audit-relationships` for ongoing data quality maintenance
