# BUG_0015 – Fabrica cleanup script wipes contenido property and throws false negatives

## Metadata

- **Status**: `in progress` (False negative fixed, property wiping still under investigation)
- **Last Updated**: 2025-11-30
- **Category**: `backend`, `cleanup`
- **Severity**: `high`
- **Environment**: Backend cleanup scripts, Admin API cleanup endpoints
- **Related Commits / PRs**: TBD

## Reproduction Steps

1. Execute the cleanup script: `POST /api/admin/cleanup/find-fabricas-missing-jingles/execute`
2. **False Negative Case**:
   - Create/verify a Fabrica (e.g., `DLe3hojAro0`) with:
     - 5 APPEARS_IN relationships to Jingles
     - `contents` property containing 7 timestamp entries in MM:SS or HH:MM:SS format (e.g., "02:30", "01:15:45", etc. in separate lines)
   - Run the script
   - **Expected**: Script should detect mismatch (7 timestamps in contents vs 5 relationships)
   - **Actual**: Script does NOT detect this mismatch because:
     - It's looking for Jingle IDs (regex `/\bj[a-z0-9]{8}\b/g`) instead of counting timestamps
     - Even if it found something, it only checks one direction
3. **Property Wiping Case** (to be confirmed):
   - Observe that the `contents` property is wiped/cleared from the Fabrica
   - Need to identify when/where this occurs

## Description

The Admin Cleanup script `find-fabricas-missing-jingles` checks if the Fabrica has the right number of Jingles based on its `contents` property. The script has two critical issues:

1. **Incorrect parsing logic**: The script incorrectly tries to parse Jingle IDs from `contents` property

   - **Current (WRONG)**: Uses regex `/\bj[a-z0-9]{8}\b/g` to find Jingle IDs in contents
   - **Expected (CORRECT)**: Should count timestamps in MM:SS or HH:MM:SS format (likely in separate text lines)
   - **Root issue**: `contents` is a user-written property with messy information, NOT expected to contain Jingle IDs
   - **Example**: Fabrica `DLe3hojAro0` has 5 APPEARS_IN relationships but `contents` suggests 7 Jingles (based on timestamp count) - script does NOT detect this mismatch because it's looking for the wrong thing

2. **Unintended side effect**: The script wipes/clears the `contents` property from the Fabrica (root cause to be identified)

**API Details**:

- **Endpoint**: `POST /api/admin/cleanup/find-fabricas-missing-jingles/execute`
- **Script ID**: `find-fabricas-missing-jingles`
- **Description** (from API docs): "Identifies Fabricas where the 'Contenidos' property contains Jingle references that are not present in the APPEARS_IN relationships"

## Root Cause

**Confirmed**: The script `findFabricasMissingJingles` uses INCORRECT parsing logic and only validates in ONE direction.

**Technical Details**:

- **API Endpoint**: `POST /api/admin/cleanup/find-fabricas-missing-jingles/execute`
- **Script Function**: `findFabricasMissingJingles()` in `backend/src/server/db/cleanup/scripts/fabricas.ts`
- **Current Logic** (lines 48-106):
  - ❌ **WRONG**: Tries to parse Jingle IDs using regex `/\bj[a-z0-9]{8}\b/g` (line 50)
  - ❌ **WRONG**: Assumes `contents` contains Jingle IDs
  - ❌ **WRONG**: Only checks if parsed "Jingle IDs" in `contents` are missing APPEARS_IN relationships
- **Expected Logic**:
  - ✅ Should count timestamps in MM:SS or HH:MM:SS format from `contents` text (using `parseTimestampFromText()`)
  - ✅ Should compare COUNT of timestamps with COUNT of APPEARS_IN relationships
  - ✅ Should flag mismatches as WARNINGS (not errors) - `requiresManualReview: true`, `automatable: false`
  - ✅ Contents is optional - missing contents is not an issue
  - ✅ Should detect mismatches in BOTH directions (more timestamps than relationships, or more relationships than timestamps)

**The Bug**:

1. **Incorrect Parsing**: The script looks for Jingle IDs when it should count timestamps

   - `contents` is a user-written property with messy text information
   - Should parse timestamps using existing utility: `parseTimestampFromText()` from `backend/src/server/utils/timestampParser.ts`
   - Example: Fabrica `DLe3hojAro0` has 5 APPEARS_IN relationships but `contents` has 7 timestamp entries - script doesn't detect this because it's looking for Jingle IDs instead of counting timestamps

2. **Validation Logic**: Should compare counts and flag as WARNING (not error)

   - Contents is optional - if missing, that's fine (not an issue)
   - If contents exists: Count timestamps and compare with relationship count
   - Flag as WARNING if counts don't match (either direction)
   - Should detect: More timestamps in contents than relationships
   - Should detect: More relationships than timestamps in contents (contents missing jingles)

3. **Property Wiping**: Still under investigation - need to identify where `contents` property is being cleared/modified

**Code Analysis**:

- Line 50: Uses wrong regex pattern `/\bj[a-z0-9]{8}\b/g` for Jingle IDs
- Lines 55-59: Tries to match Jingle IDs in contents (wrong approach)
- Missing: Logic to parse and count timestamps from contents text
- Missing: Logic to compare counts in both directions
- **Available Utility**: `parseTimestampFromText()` exists in `backend/src/server/utils/timestampParser.ts` but is not used

## Resolution

**Status**: `resolved` - False negative issue fixed (2025-11-30)

**Resolution Approach**: Fixed parsing logic to count timestamps instead of Jingle IDs

**Implementation**:

1. **Fixed Parsing Logic**:

   - Removed incorrect Jingle ID regex pattern `/\bj[a-z0-9]{8}\b/g`
   - Added import for `parseTimestampFromText()` from `backend/src/server/utils/timestampParser.ts`
   - Changed logic to count timestamps in MM:SS or HH:MM:SS format from contents text (line by line)

2. **Fixed Validation Logic**:

   - Now compares count of timestamps with count of APPEARS_IN relationships
   - Handles missing contents gracefully (not an issue since contents is optional)
   - Flags mismatches as WARNINGS (not errors) - `automatable: false`, `requiresManualReview: true`

3. **Updated Automation Function**:

   - Marked as non-automatable since timestamps cannot be automatically matched to Jingles
   - Function now always skips with appropriate error message

4. **Updated Script Registration**:
   - Changed `automatable: false` in script metadata
   - Updated description to reflect timestamp-based validation

**Files Changed**:

- `backend/src/server/db/cleanup/scripts/fabricas.ts`: Fixed `findFabricasMissingJingles()` and `automateFabricasMissingJingles()`
- `backend/src/server/db/cleanup/index.ts`: Updated script registration metadata

**Remaining Issue**: Property wiping - still under investigation to identify where `contents` property is being cleared/modified

**Update (2025-11-30)**: Fixed false positives for M:SS format

- Updated `parseTimestampFromText()` to handle single-digit minutes (M:SS format like "5:30")
- Added M:SS pattern after MM:SS pattern to avoid false matches
- Updated both backend and frontend parsers for consistency

## Related Files

- `backend/src/server/db/cleanup/scripts/fabricas.ts`: Search for `findFabricasMissingJingles`, `automateFabricasMissingJingles` - Main cleanup script for Fabricas that checks contents property
  - **Issue**: Lines 48-106 use wrong parsing logic (Jingle IDs instead of timestamps)
- `backend/src/server/utils/timestampParser.ts`: Search for `parseTimestampFromText` - Utility function that should be used to parse timestamps from contents
  - **Available**: Function exists but is not used by the cleanup script
- `backend/src/server/db/cleanup/index.ts`: Search for `find-fabricas-missing-jingles` - Script registration
- `backend/src/server/api/admin.ts`: Search for `cleanup` - API endpoints for cleanup scripts
- `docs/5_backend_api-contracts/contracts/admin-api-cleanup.md`: API contract documentation mentioning "Contenidos" property

## Related Code

- `findFabricasMissingJingles()`: Function that queries Fabricas with contents property and compares with APPEARS_IN relationships
  - **Location**: `backend/src/server/db/cleanup/scripts/fabricas.ts:23-128`
  - **Issue**: Lines 62-65 only check one direction (contents → relationships)
  - **Missing**: Check for relationships → contents mismatch
- `automateFabricasMissingJingles()`: Automation function that creates missing APPEARS_IN relationships
  - **Location**: `backend/src/server/db/cleanup/scripts/fabricas.ts:133-282`
- Query pattern: `MATCH (f:Fabrica) WHERE f.contents IS NOT NULL AND f.contents <> '' OPTIONAL MATCH (j:Jingle)-[r:APPEARS_IN]->(f)`
- **WRONG**: Jingle ID pattern: `/\bj[a-z0-9]{8}\b/g` - Regex incorrectly used to extract Jingle IDs from contents (line 50)
- **SHOULD USE**: `parseTimestampFromText()` from `backend/src/server/utils/timestampParser.ts` to count timestamps

**Specific Code Issue** (lines 48-106):

```typescript
// CURRENT (WRONG): Lines 48-50
// Parse Jingle IDs from contents
// Assumes Jingle IDs are in format j{8-chars} and appear in the text
const jingleIdPattern = /\bj[a-z0-9]{8}\b/g;

// Lines 55-59: Tries to match Jingle IDs
const matches = result.contents.match(jingleIdPattern);
if (!matches) continue;
const referencedJingleIds = [...new Set(matches)];

// SHOULD BE: Count timestamps instead
// import { parseTimestampFromText } from '../../../utils/timestampParser';
// const lines = result.contents.split('\n');
// const timestampCount = lines.filter(line => parseTimestampFromText(line) !== null).length;
// const relationshipCount = result.existingJingleIds.length;
// if (timestampCount !== relationshipCount) {
//   // Report mismatch
// }
```

## Related tests

TBD - Need to identify or create tests for this cleanup script
