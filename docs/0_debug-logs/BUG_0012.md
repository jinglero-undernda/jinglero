# BUG_0012 â€“ Tematica page doesn't show Jingles with null timestamps

## Metadata

- **Status**: `in progress`
- **Last Updated**: 2025-01-27
- **Category**: `frontend`, `backend`, `validation`
- **Severity**: `high`
- **Environment**: Admin Entity page (Tematica page), Chrome/Safari, localhost:5173
- **Related Commits / PRs**: TBD

## Reproduction Steps

1. Navigate to a Jingle page (e.g., `http://localhost:5173/admin/j/j1anqw115`)
2. Note that the Jingle has a relationship to a Tematica (e.g., "AC/DC invita a Milei (Fake News)")
3. Navigate to the Tematica page (e.g., `http://localhost:5173/admin/t/t1fr6i97z`)
4. **Expected**: The Jingle should appear in the Jingles list
5. **Actual**: The Jingle does not appear in the list

## Description

When viewing a Tematica page in the Admin interface, Jingles that are tagged with that Tematica are not displayed if they have a `null` timestamp. The console shows validation errors indicating that the schema expects a number but receives `null`.

**Console Error Evidence**:

```
Validation error in fetchTematicaJingles(t1fr6i97z)[0]:
{
  "expected": "number",
  "code": "invalid_type",
  "path": ["timestamp"],
  "message": "Invalid input: expected number, received null"
}
```

**The Problem**:

1. The API endpoint `/entities/tematicas/:id/related` returns Jingles with `timestamp: null` when the Jingle doesn't have an APPEARS_IN relationship
2. The query returns `j.timestamp` from the Jingle node, but timestamps are stored in the APPEARS_IN relationship, not on the Jingle node
3. When there's no APPEARS_IN relationship (OPTIONAL MATCH), `j.timestamp` is `null`
4. `JinglePartialSchema` expects `timestamp: z.number().optional()`, which allows `undefined` but NOT `null`
5. Validation fails, causing the Jingle to be skipped
6. The Jingle doesn't appear in the UI even though it exists and is tagged with the Tematica

## Expected Behavior

1. User navigates to a Tematica page
2. All Jingles tagged with that Tematica should appear in the list
3. Jingles without APPEARS_IN relationships (and thus no timestamp) should still appear
4. Timestamps should be displayed correctly when available, or shown as empty/missing when not available

## Observed Behavior

1. User navigates to a Tematica page
2. Jingles with `null` timestamps are filtered out during validation
3. Only Jingles with valid timestamps appear in the list
4. Console shows validation errors for each skipped Jingle

## Root Cause

**CONFIRMED: Schema validation error - JinglePartialSchema doesn't allow null timestamps**

The root cause is a **schema validation failure** in `fetchTematicaJingles`. The function uses `JinglePartialSchema` which expects `timestamp: z.number().optional()`, but the API returns Jingles with `timestamp: null` when there's no APPEARS_IN relationship.

**Additional Issue: API query returns timestamp from wrong source**

The API query at `/entities/tematicas/:id/related` returns `j.timestamp` from the Jingle node, but timestamps are stored in the APPEARS_IN relationship (`appearsIn.timestamp`). When there's no APPEARS_IN relationship (OPTIONAL MATCH), `j.timestamp` is `null`.

**The Problem**:

1. `fetchTematicaJingles` uses `publicApi.getTematicaRelated(tematicaId)` (line 551)
2. The API query returns `j { .timestamp, ... }` which gets timestamp from the Jingle node (line 1055 in `public.ts`)
3. Timestamps are stored in the APPEARS_IN relationship, not on the Jingle node
4. When there's no APPEARS_IN relationship, `j.timestamp` is `null`
5. Validation uses `JinglePartialSchema` which has `timestamp: z.number().optional()` (allows undefined, not null)
6. Validation fails, causing the function to skip the Jingle
7. No relationships appear in the UI even though they exist in the database

**Key Finding**:

- Similar to BUG_0011, but in that case the timestamp was `undefined`, not `null`
- BUG_0011 was fixed by using `JinglePartialArraySchema` which has `timestamp: z.number().optional()`
- However, `z.number().optional()` allows `undefined` but NOT `null`
- The API returns `null` when there's no APPEARS_IN relationship

**Impact**:

1. Jingles without APPEARS_IN relationships don't appear on Tematica pages
2. This affects any Jingle that hasn't been associated with a Fabrica yet
3. The validation error is logged but the Jingle is silently skipped

## Resolution

**Status**: `in progress`

**Fix Required**:

1. **Update `JinglePartialSchema`** to allow `null` for timestamp:
   - Change from `timestamp: z.number().optional()` 
   - To `timestamp: z.union([z.number(), z.null()]).optional()` or `timestamp: z.number().nullable().optional()`

2. **Fix API query** to get timestamp from APPEARS_IN relationship:
   - Change from `j { .timestamp, ... }`
   - To include `timestamp: appearsIn.timestamp` in the jingle object

**Why Both Fixes Are Needed**:

- The schema fix ensures validation doesn't fail when timestamp is `null` (defensive programming)
- The API fix ensures timestamps are retrieved from the correct source (the APPEARS_IN relationship)
- Even with the API fix, some Jingles may legitimately not have APPEARS_IN relationships, so the schema should handle `null`

## Related Files

- `frontend/src/lib/services/relationshipService.ts`
  - Search for: `fetchTematicaJingles` - Line ~548-589: Function that fetches Tematica Jingles
  - Search for: `JinglePartialSchema` - Line ~561: Validation schema used
  - Search for: `safeParse` - Line ~561: Validation function that fails on null

- `frontend/src/lib/validation/relationshipSchemas.ts`
  - Search for: `JinglePartialSchema` - Line ~181-236: Schema definition
  - Search for: `timestamp: z.number().optional()` - Line ~185: Current schema that doesn't allow null

- `backend/src/server/api/public.ts`
  - Search for: `/entities/tematicas/:id/related` - Line ~1045-1085: API endpoint
  - Search for: `jinglesByTematicaQuery` - Line ~1052-1059: Query that returns `j.timestamp`
  - Search for: `j { .timestamp, ... }` - Line ~1055: Returns timestamp from Jingle node instead of APPEARS_IN relationship

## Related Code

### Current Implementation (Buggy)

**relationshipSchemas.ts - JinglePartialSchema**:

```typescript
// Line ~185: Current schema that doesn't allow null
timestamp: z.number().optional(), // Allow optional since API may not return it in partial responses
```

**Problem**: `z.number().optional()` allows `undefined` but NOT `null`. When API returns `null`, validation fails.

**public.ts - API Query**:

```cypher
// Line ~1055: Returns timestamp from Jingle node
RETURN j { .id, .title, .songTitle, .comment, .timestamp, ... } AS jingle
```

**Problem**: Timestamps are stored in the APPEARS_IN relationship, not on the Jingle node. When there's no APPEARS_IN relationship, `j.timestamp` is `null`.

### Expected Fix

**relationshipSchemas.ts - JinglePartialSchema**:

```typescript
// Should allow null
timestamp: z.union([z.number(), z.null()]).optional(),
// OR
timestamp: z.number().nullable().optional(),
```

**public.ts - API Query**:

```cypher
// Should get timestamp from APPEARS_IN relationship
RETURN j { 
  .id, 
  .title, 
  .songTitle, 
  .comment, 
  timestamp: appearsIn.timestamp,  // Get from relationship, not node
  ...
} AS jingle
```

## Related Bugs

- **BUG_0010**: Timestamps show 00:00:00 in Admin interface - **RESOLVED**
  - Related: Schema migration to integer timestamps
  - Schema was updated to require `z.number()` but didn't account for `null` values

- **BUG_0011**: REPEATS relationship creation doesn't show entity after creation - **RESOLVED**
  - Very similar issue: validation failed because timestamp was `undefined`
  - Fix: Changed to `JinglePartialArraySchema` which has `timestamp: z.number().optional()`
  - **This bug is similar but timestamp is `null` instead of `undefined`**

## Next Steps

1. Update `JinglePartialSchema` to allow `null` for timestamp
2. Fix API query to get timestamp from APPEARS_IN relationship
3. Test with Jingles that have null timestamps
4. Verify no validation errors in console
5. Verify all Jingles appear on Tematica pages

