# BUG_0009 – RelatedEntities uses wrong entity ID when mismatch detected, causing "Jingle not found" error

## Metadata

- **Status**: `open`
- **Last Updated**: 2025-01-27
- **Category**: `frontend`
- **Severity**: `high`
- **Environment**: Browser (Chrome/Safari), localhost:5173, Admin area
- **Related Commits / PRs**: TBD

## Reproduction Steps

1. Navigate to a Jingle admin page (e.g., `/admin/j/jof56g6vj`)
2. Observe console error:
   ```
   [fetchJingleAllRelationships] Error fetching jingle ty2ux6e1k: Error: Jingle not found
   ```
3. The error occurs even though the page loads correctly afterward

**Expected behavior**: When loading a Jingle, `RelatedEntities` should use the correct Jingle ID (`jof56g6vj`) to fetch relationships. If there's a race condition where the wrong entity ID is detected, the component should skip loading until the correct entity is available.

**Actual behavior**: When a mismatch is detected (e.g., Tematica ID `ty2ux6e1k` detected when entityType is `jingle`), the validation guard uses `effectiveEntityType = 'tematica'` but still calls `fetchJingleAllRelationships('ty2ux6e1k')`, which tries to fetch a Jingle with a Tematica ID, resulting in a 404 error.

## Description

When loading a Jingle in the Admin page, a console error appears: `[fetchJingleAllRelationships] Error fetching jingle ty2ux6e1k: Error: Jingle not found`. The ID `ty2ux6e1k` is a Tematica ID (9 characters, starts with 't'), not a Jingle ID. This suggests a race condition where stale entity data (a Tematica ID) is being used when fetching Jingle relationships.

**Console Output**:
```
[RelatedEntities] Blank row hidden for Cancion-cancion {isAdmin: true, isEditing: false, isReadOnly: undefined, maxCardinality: 1, currentCount: 0}
[RelatedEntities] Blank row hidden for Autor-artista {isAdmin: true, isEditing: false, isReadOnly: true, maxCardinality: undefined, currentCount: 0}
[RelatedEntities] Blank row hidden for Jinglero-artista {isAdmin: true, isEditing: false, isReadOnly: undefined, maxCardinality: undefined, currentCount: 0}
[RelatedEntities] Blank row hidden for Tematicas-tematica {isAdmin: true, isEditing: false, isReadOnly: undefined, maxCardinality: undefined, currentCount: 0}
[RelatedEntities] state updated: {expandedRelationships: Array(5), expandedEntities: Array(0), loadedDataKeys: Array(0), loadedDataCounts: Array(0)}
relationshipService.ts:137 [fetchJingleAllRelationships] Error fetching jingle ty2ux6e1k: Error: Jingle not found
```

**Key Observations**:
- The error occurs during initial relationship loading
- The ID `ty2ux6e1k` is a Tematica ID (related to Jingle `jof56g6vj` via `TAGGED_WITH`)
- The page eventually loads correctly, suggesting the error is from a race condition
- The validation guard from BUG_0005 detects the mismatch but still attempts to use the wrong entity ID

## Root Cause

**Hypothesis**: The validation guard in `RelatedEntities.tsx` (lines 1468-1486) detects when `entity.id` doesn't match `entityType`, but instead of **skipping loading** (as intended in BUG_0003), it tries to "fix" the mismatch by using `effectiveEntityType = detectedType`. However, this still uses the wrong `entity.id`:

1. User navigates to Jingle page `/admin/j/jof56g6vj`
2. Due to a race condition (similar to BUG_0003), `entity.id` temporarily contains `ty2ux6e1k` (a Tematica ID from a previous page or stale state)
3. Validation guard detects mismatch:
   - `detectedType = getEntityTypeFromId('ty2ux6e1k')` → `'tematica'`
   - `entityType = 'jingle'` (from URL params)
   - Mismatch detected: `'tematica' !== 'jingle'`
4. Guard sets `effectiveEntityType = 'tematica'` (from BUG_0005 fix)
5. **Bug**: Still calls `rel.fetchFn(entity.id, effectiveEntityType)` where:
   - `entity.id = 'ty2ux6e1k'` (wrong - Tematica ID)
   - `effectiveEntityType = 'tematica'` (wrong - should be 'jingle')
   - For Jingle relationship configs, `fetchFn` calls `fetchJingleAllRelationships('ty2ux6e1k')`
   - This tries to fetch a Jingle with Tematica ID → 404 error

**The core issue**: The fix from BUG_0005 was intended to handle transient mismatches during redirects, but it's being applied incorrectly. When `entity.id` doesn't match `entityType`, the component should **skip loading** until the entity and entityType are synchronized, not try to use the wrong entity ID.

**Why this happens**: The race condition from BUG_0003 may not be fully resolved. Even though `setEntity(null)` is called in `AdminEntityAnalyze`, there might be a brief window where:
- Old entity state persists (due to React's async state updates)
- New `entityType` prop arrives from URL params
- `RelatedEntities` renders with mismatched data before the new entity is loaded

## Resolution

**Status**: `open`

**Proposed Fix**:

When a mismatch is detected between `entity.id` and `entityType`, the component should **skip loading relationships** until the entity and entityType are synchronized. The fix from BUG_0005 that tries to use `effectiveEntityType` should be reverted or modified to skip loading instead.

**Option 1: Skip loading on mismatch (recommended)**:
```typescript
useEffect(() => {
  if (entityPath.length <= 1 && entity?.id) {
    const detectedType = getEntityTypeFromId(entity.id);
    
    // If detectedType doesn't match entityType, skip loading until synchronized
    if (detectedType && detectedType !== entityType) {
      console.warn('[RelatedEntities] Entity ID/Type mismatch detected, skipping load:', {
        entityId: entity.id,
        detectedType,
        expectedType: entityType,
        entityPath,
        action: 'Skipping relationship loading until entity and entityType are synchronized',
      });
      return; // Skip loading relationships until entity and entityType match
    }
    
    // Continue loading relationships with correct entity ID and type
    // ...
  }
}, [entity?.id, entityType, relationships, isAdmin, ...]);
```

**Option 2: Verify entity.id matches entityType before using it**:
Add an additional check to ensure `entity.id` is actually a valid ID for the `entityType` before calling `fetchFn`. This would catch cases where the wrong entity ID is being used.

**Validation Required**:
- Navigate to Jingle admin page - should not see "Jingle not found" error
- Navigate between different entity types - should not see errors with wrong entity IDs
- Relationships should load correctly once entity and entityType are synchronized
- No linter errors introduced

## Related Files

- `/Users/william/Usina/jinglero/frontend/src/components/common/RelatedEntities.tsx`
  - Search for: `Entity ID/Type mismatch detected, using detected type`
  - Line ~1468-1486: Validation guard that detects mismatches - **needs fix**
  - Line ~1562: Where `rel.fetchFn(entity.id, effectiveEntityType)` is called with potentially wrong entity ID
  - Line ~1467-1627: useEffect that auto-loads relationships on mount

- `/Users/william/Usina/jinglero/frontend/src/pages/admin/AdminEntityAnalyze.tsx`
  - Search for: `setEntity(null)`
  - Line ~107: Clears entity state when loading new entity (from BUG_0003 fix)
  - Line ~103-166: `fetchEntity` function that loads entities
  - May need additional investigation to ensure entity state is cleared properly

- `/Users/william/Usina/jinglero/frontend/src/lib/services/relationshipService.ts`
  - Search for: `async function fetchJingleAllRelationships`
  - Line ~111-151: Function that throws "Jingle not found" error
  - Line ~125: `await publicApi.getJingle(jingleId)` - where 404 originates

- `/Users/william/Usina/jinglero/frontend/src/lib/utils/entityTypeUtils.ts`
  - Search for: `export function getEntityTypeFromId`
  - Line ~183-209: Function that detects entity type from ID (fixed in BUG_0004)

## Related Code

### Current Implementation (Buggy)

**RelatedEntities.tsx - Validation Guard (from BUG_0005 fix)**:
```typescript
useEffect(() => {
  if (entityPath.length <= 1 && entity?.id) {
    const detectedType = getEntityTypeFromId(entity.id);
    
    // If there's a mismatch, trust the detectedType from the entity ID (more reliable)
    let effectiveEntityType = entityType;
    if (detectedType && detectedType !== entityType) {
      console.warn('[RelatedEntities] Entity ID/Type mismatch detected, using detected type:', {
        entityId: entity.id,
        detectedType,
        propEntityType: entityType,
      });
      effectiveEntityType = detectedType; // ❌ Still uses wrong entity.id
    }
    
    // Later: calls rel.fetchFn(entity.id, effectiveEntityType)
    // If entity.id = 'ty2ux6e1k' (Tematica) and effectiveEntityType = 'tematica',
    // but rel is a Jingle relationship config, it calls fetchJingleAllRelationships('ty2ux6e1k')
    // → tries to fetch Jingle with Tematica ID → 404 error
  }
}, [entity?.id, entityType, ...]);
```

**Problem**: When mismatch is detected:
- `entity.id = 'ty2ux6e1k'` (Tematica ID - wrong)
- `entityType = 'jingle'` (from URL - correct)
- `detectedType = 'tematica'` (from ID - correct for that ID)
- `effectiveEntityType = 'tematica'` (set by guard)
- But `rel.fetchFn(entity.id, effectiveEntityType)` still uses wrong `entity.id`
- For Jingle relationship configs, this calls `fetchJingleAllRelationships('ty2ux6e1k')` → error

### Proposed Fix

**Option 1: Skip loading on mismatch**:
```typescript
useEffect(() => {
  if (entityPath.length <= 1 && entity?.id) {
    const detectedType = getEntityTypeFromId(entity.id);
    
    // If detectedType doesn't match entityType, skip loading until synchronized
    if (detectedType && detectedType !== entityType) {
      console.warn('[RelatedEntities] Entity ID/Type mismatch detected, skipping load:', {
        entityId: entity.id,
        detectedType,
        expectedType: entityType,
        action: 'Skipping until synchronized',
      });
      return; // ✅ Skip loading instead of using wrong entity ID
    }
    
    // Continue loading with correct entity ID and type
    // ...
  }
}, [entity?.id, entityType, ...]);
```

## Related Bugs

- **BUG_0003**: Admin page fetching wrong entity type on navigation - **RESOLVED**
  - Similar race condition issue, but this bug shows the fix from BUG_0005 is causing new problems
- **BUG_0005**: RelatedEntities false positive mismatch warning on page reload - **RESOLVED**
  - The fix from this bug (using `effectiveEntityType`) is causing the current bug
  - The fix was intended to handle transient mismatches, but it's being applied incorrectly

