# BUG_0011 – REPEATS relationship creation doesn't show entity after creation

## Metadata

- **Status**: `resolved`
- **Last Updated**: 2025-11-22
- **Category**: `frontend`
- **Severity**: `high`
- **Environment**: Admin Entity page (Jingle page), Edit mode, Chrome/Safari, localhost:5173
- **Related Commits / PRs**: TBD

## Reproduction Steps

1. Navigate to Admin Entity page for a Jingle (e.g., `/admin/j/[jingle-id]`)
2. Click "Editar" to enter Edit mode
3. Find the "Versiones" (REPEATS) relationship section
4. Click "Crear relacion" (Create relationship) or click on blank row
5. Select another Jingle to create REPEATS relationship with
6. **Expected**: The relationship should be created and the selected Jingle should appear in the "Versiones" list
7. **Actual**: The relationship creation appears to succeed, but the entity does not show in the list after creation

## Description

When creating a REPEATS relationship from a Jingle page to another Jingle in Edit mode, the relationship creation workflow completes without errors, but the created relationship does not appear in the UI. The user follows the expected creation workflow, but the entity is not visible afterwards.

**Key Observations**:

- Relationship creation API call may succeed (needs verification via console logs)
- After refresh, the relationship is not visible in the "Versiones" section
- Similar to BUG_0006 (VERSIONA relationship direction issue), but for REPEATS relationships
- REPEATS relationships are self-referential (Jingle → Jingle) and have special direction validation logic in the API

## Expected Behavior

1. User creates REPEATS relationship via UI
2. API validates and corrects direction automatically (based on fabricaDate/createdAt)
3. Relationship is created in the database
4. UI refreshes and displays the related Jingle in the "Versiones" section
5. Relationship is visible on both Jingle pages (bidirectional display)

## Observed Behavior

1. User creates REPEATS relationship via UI
2. Relationship creation appears to complete (no error shown)
3. UI refreshes but the related Jingle does not appear in the "Versiones" section
4. Relationship may or may not exist in the database (needs investigation)

## Root Cause

**CONFIRMED: Schema validation error - JingleArraySchema requires timestamp but API returns undefined**

The actual root cause is a **schema validation failure** in `fetchJingleRepeats`. The function uses `JingleArraySchema` which requires `timestamp` to be a number, but the Jingle objects returned from the API don't have a `timestamp` field (or it's undefined).

**Console Error Evidence**:

```
Validation error in fetchJingleRepeats(jg9ktoevy):
{
  "expected": "number",
  "code": "invalid_type",
  "path": [0, "timestamp"],
  "message": "Invalid input: expected number, received undefined"
}
```

**The Problem**:

1. `fetchJingleRepeats` fetches Jingles using `publicApi.getJingle(id)` (line 357)
2. The Jingle objects returned don't have a `timestamp` field (or it's `undefined`)
3. Validation uses `JingleArraySchema` which requires `timestamp: z.number()` (required, not optional)
4. Validation fails, causing the function to return an empty array or filtered results
5. No relationships appear in the UI even though they exist in the database

**Additional Issue: fetchJingleRepeats uses different API endpoint and cache mechanism**

Additionally, `fetchJingleRepeats` uses a **different API endpoint** than other Jingle relationship functions, and therefore **does not use the same cache** that `clearJingleRelationshipsCache` clears. This may cause stale data issues, but the immediate blocker is the validation error.

**Key Finding**:

- Other Jingle relationship functions (`fetchJingleFabrica`, `fetchJingleCancion`, `fetchJingleAutores`, `fetchJingleJingleros`, `fetchJingleTematicas`) all use `fetchJingleAllRelationships()`, which:

  - Calls `publicApi.getJingle(jingleId)`
  - Uses `jingleRelationshipsCache` for caching
  - Can be cleared with `clearJingleRelationshipsCache(jingleId)`

- `fetchJingleRepeats` (line 321-375) uses:
  - `publicApi.getEntityRelationships('jingles', jingleId)` - **Different endpoint**
  - Does NOT use `fetchJingleAllRelationships()` or `jingleRelationshipsCache`
  - Therefore, `clearJingleRelationshipsCache()` has **no effect** on REPEATS relationships

**Impact**:

1. When a REPEATS relationship is created, `clearJingleRelationshipsCache()` is called (lines 920-925)
2. This clears the cache for `fetchJingleAllRelationships()`, but NOT for `fetchJingleRepeats()`
3. The refresh call to `fetchJingleRepeats()` may return stale data from a different cache (or no cache)
4. The newly created relationship doesn't appear because the refresh is using stale data

**Additional Issues**:

- REPEATS relationships fall through to default case in `handleCreateRelationship` (lines 699-703)
- No explicit REPEATS handling like other relationship types
- Cache clearing logic doesn't account for REPEATS using a different endpoint

## Resolution

**Status**: `resolved` - Fixed on 2025-11-22

**Root Cause Confirmed**: `fetchJingleRepeats` was using `JingleArraySchema` which requires `timestamp: z.number()`, but the API returns Jingles without a `timestamp` field (or it's undefined). This caused validation to fail and return an empty array, preventing REPEATS relationships from displaying.

**Fix Applied**:

Changed `JingleArraySchema` to `JinglePartialArraySchema` in `fetchJingleRepeats` function.

**File**: `frontend/src/lib/services/relationshipService.ts`
**Line**: 367
**Change**:

```typescript
// Before:
const validated = safeParseArray(
  JingleArraySchema,
  jingles,
  `fetchJingleRepeats(${jingleId})`
) as unknown as Jingle[];

// After:
const validated = safeParseArray(
  JinglePartialArraySchema,
  jingles,
  `fetchJingleRepeats(${jingleId})`
) as unknown as Jingle[];
```

**Why**: `JinglePartialArraySchema` uses `JinglePartialSchema` which has `timestamp: z.number().optional()`, allowing Jingles without timestamps to pass validation. This matches the pattern used in `fetchCancionJingles` (line 426) for similar reasons.

**Validation**:

- No linter errors introduced
- Schema change aligns with existing pattern for partial Jingle data
- `JinglePartialArraySchema` is already imported, no import changes needed

**Testing Required**:

1. Navigate to a Jingle admin page with existing REPEATS relationships
2. Verify no validation errors in console
3. Verify REPEATS relationships appear in the "Versiones" section
4. Test creating a new REPEATS relationship and verify it appears immediately after creation

**Additional Notes**:

- The caching issue identified during investigation (different API endpoint) may still exist but is not blocking display
- If caching issues are observed after this fix, consider implementing Option 2 or Option 3 from the original investigation
- The fix resolves the immediate blocker (validation error) that prevented relationships from displaying

## Related Files

- `frontend/src/components/common/RelatedEntities.tsx`

  - Search for: `handleCreateRelationship`
  - Line ~594-976: Relationship creation handler - **REPEATS falls through to default case**
  - Line ~699-703: Default case that handles REPEATS (may be incorrect)
  - Line ~911-926: Cache clearing logic - **may not handle REPEATS correctly**
  - Line ~928-976: Refresh logic after relationship creation
  - Line ~1395-1399: REPEATS handling in `getRelationshipProperties` (different function)

- `frontend/src/lib/services/relationshipService.ts`

  - Search for: `fetchJingleRepeats`
  - Line ~321-375: Function that fetches REPEATS relationships
  - Line ~324: Uses `publicApi.getEntityRelationships('jingles', jingleId)` - **DIFFERENT ENDPOINT** than other relationship functions
  - Line ~333-348: Filters for REPEATS relationships in both directions
  - Line ~357: Fetches individual Jingles using `publicApi.getJingle(id)`
  - Line ~367: **FIXED**: Changed from `JingleArraySchema` to `JinglePartialArraySchema` (2025-11-22)
  - **FIXED**: Now uses `JinglePartialArraySchema` which allows optional timestamp, matching API response format
  - **ADDITIONAL ISSUE**: Does NOT use `fetchJingleAllRelationships()` or `jingleRelationshipsCache`
  - **ADDITIONAL ISSUE**: `clearJingleRelationshipsCache()` has no effect on this function

- `frontend/src/lib/validation/relationshipSchemas.ts`

  - Search for: `JingleArraySchema` or `JinglePartialArraySchema`
  - Line ~132-136: `JingleSchema` requires `timestamp: z.number()` (required)
  - Line ~181-185: `JinglePartialSchema` has `timestamp: z.number().optional()` (optional)
  - Line ~266: `JingleArraySchema = z.array(JingleSchema)` - uses strict schema
  - Line ~272: `JinglePartialArraySchema = z.array(JinglePartialSchema)` - uses flexible schema

- `frontend/src/lib/utils/relationshipConfigs.ts`

  - Search for: `Versiones` or `fetchJingleRepeats`
  - Line ~75-80: REPEATS relationship configuration
  - Line ~79: Uses `fetchJingleRepeats` as fetch function

- `backend/src/server/api/admin.ts`

  - Search for: `POST /relationships/repeats` or `if (neo4jRelType === 'REPEATS')`
  - Line ~869-920: REPEATS relationship creation with direction validation
  - Line ~887-889: Direction correction logic
  - Line ~916: Transitive normalization logic

- `backend/src/server/db/validation/repeats-validation.ts`
  - Search for: `validateRepeatsDirection`
  - Direction validation and correction logic

## Related Code

### Current Implementation (Potentially Buggy)

**RelatedEntities.tsx - handleCreateRelationship (REPEATS handling)**:

```typescript
// Lines 699-703: Default case - REPEATS falls through here
} else {
  // Default: current entity is start, selected entity is end
  startId = entity.id;
  endId = selectedEntity.id;
}
```

**Problem**: REPEATS relationships use default logic, which may not account for:

- API direction correction
- Bidirectional relationship display
- Cache clearing for both Jingles

**Comparison with other relationship types**:

- `versiona` (lines 644-660): Explicitly handles Jingle → Cancion direction
- `tagged_with` (lines 683-698): Explicitly handles Jingle → Tematica direction
- `appears_in` (lines 631-643): Explicitly handles Jingle → Fabrica direction
- **REPEATS**: No explicit handling, uses default ❌

### Cache Clearing Logic

**RelatedEntities.tsx - Cache clearing (lines 911-926)**:

```typescript
if (relType === "tagged_with") {
  // TAGGED_WITH is always Jingle -> Tematica, so startId is the jingle
  clearJingleRelationshipsCache(startId);
} else {
  // For other relationships, clear cache if either entity is a jingle
  if (entityType === "jingle") {
    clearJingleRelationshipsCache(entity.id);
  }
  if (rel.entityType === "jingle" && selectedEntity.id) {
    clearJingleRelationshipsCache(selectedEntity.id);
  }
}
```

**For REPEATS**:

- `entityType === 'jingle'` is true (we're on a Jingle page)
- `rel.entityType === 'jingle'` is true (REPEATS is Jingle → Jingle)
- Code clears cache for both `entity.id` and `selectedEntity.id` (lines 920-925)
- **BUT**: `clearJingleRelationshipsCache()` only affects `fetchJingleAllRelationships()` cache
- **ROOT CAUSE**: `fetchJingleRepeats()` uses `getEntityRelationships()` which has a different cache (or no cache)
- **Result**: Cache clearing has no effect on REPEATS relationships

## Related Bugs

- **BUG_0006**: Relationship creation creates wrong direction for versiona, entity not visible after creation - **RESOLVED**

  - Very similar issue: relationship created with wrong direction, entity not visible after creation
  - Fix: Added explicit direction handling for `versiona` relationships
  - **REPEATS may need similar fix**

- **BUG_0009**: RelatedEntities uses wrong entity ID when mismatch detected - **OPEN**
  - Different issue (ID mismatch vs direction), but both involve relationship loading problems

## Next Steps

1. **Add console logging** to track REPEATS relationship creation:

   - Log `startId` and `endId` before API call
   - Log API response
   - Log refresh query results
   - Log cache clearing actions

2. **Verify database state** after relationship creation:

   - Check if relationship exists
   - Check direction of relationship
   - Verify API direction correction worked

3. **Test fetchJingleRepeats**:

   - Verify it correctly queries both inbound and outbound relationships
   - Test with relationships created in different directions

4. **Fix implementation** (after investigation):
   - Add explicit REPEATS handling in `handleCreateRelationship`
   - Ensure cache clearing handles both Jingles
   - Verify refresh logic works with API direction correction
