# BUG_0006 – Relationship creation creates wrong direction for versiona, entity not visible after creation

## Metadata

- **Status**: `resolved`
- **Last Updated**: 2025-11-18
- **Category**: `frontend`
- **Severity**: `high`
- **Environment**: Admin Entity page (e.g., `/admin/j/jyzjddkg7`), Edit mode, Chrome/Safari, localhost:5173
- **Related Commits / PRs**: _TBD_

## Reproduction Steps

1. Navigate to Admin Entity page (e.g., `/admin/j/jyzjddkg7` - a Jingle page)
2. Click "Editar" to enter Edit mode
3. Look for a related entity (e.g., Cancion `c2idg5x12`)
4. Click "Crear relacion" (Create relationship)
5. **Expected**: The entity should appear in the relationship list and the relationship should be created
6. **Actual**: The entity does not show in the page, and the relationship is not visible when navigating back to either entity

**Console Output**:

```
[RelatedEntities] handleCreateRelationship called {selectedEntityForRelationship: {…}, entityId: 'jyzjddkg7', entityType: 'jingle', isEditing: true, timestamp: '2025-11-18T11:35:24.942Z'}
[RelatedEntities] Relationship type determined: versiona
[RelatedEntities] Creating relationship via API: {endpoint: '/relationships/versiona', payload: {…}, timestamp: '2025-11-18T11:35:24.943Z'}
[RelatedEntities] Relationship created successfully: {response: {…}, relType: 'versiona', startId: 'c2idg5x12', endId: 'jyzjddkg7', timestamp: '2025-11-18T11:35:25.236Z'}
[RelatedEntities] Starting refresh after relationship creation {key: 'Cancion-cancion', relType: 'versiona', entityId: 'jyzjddkg7', entityType: 'jingle', timestamp: '2025-11-18T11:35:25.236Z'}
[RelatedEntities] Fetching relationship data... {key: 'Cancion-cancion', entityId: 'jyzjddkg7', entityType: 'jingle'}
[RelatedEntities] Refreshed Cancion-cancion relationship data: {entityId: 'jyzjddkg7', entityType: 'jingle', relType: 'versiona', entitiesCount: 0, entities: Array(0), …}
[RelatedEntities] Dispatched LOAD_SUCCESS, relationship should now be visible
```

**Key Observations**:

- Relationship creation API call succeeds (`Relationship created successfully`)
- Relationship is created with `startId: 'c2idg5x12'` (Cancion), `endId: 'jyzjddkg7'` (Jingle)
- After refresh, `entitiesCount: 0` - no entities found
- The relationship is not visible on either entity page

## Description

When creating a `versiona` relationship from a Jingle page to a Cancion in Edit mode, the relationship is created successfully via the API, but:

1. The relationship is created in the **wrong direction** (Cancion → Jingle instead of Jingle → Cancion)
2. After refresh, the query doesn't find the relationship because it's looking in the correct direction (Jingle → Cancion)
3. The entity doesn't appear in the UI and the relationship is effectively invisible

According to the specification, `VERSIONA` relationships should always be `(Jingle)-[VERSIONA]->(Cancion)`, but the current code creates them as `(Cancion)-[VERSIONA]->(Jingle)` when creating from a Jingle page.

## Root Cause

**Confirmed**: The bug is in `handleCreateRelationship` function in `RelatedEntities.tsx` (lines 630-633).

The logic for determining `startId` and `endId` for `versiona` relationships is incorrect:

```typescript
} else if (relType === 'versiona') {
  // Jingle -> Cancion
  startId = rel.entityType === 'cancion' ? selectedEntity.id : entity.id;
  endId = rel.entityType === 'cancion' ? entity.id : selectedEntity.id;
}
```

**Problem**: This logic checks `rel.entityType === 'cancion'` (the selected entity type) to determine direction, but it should check `entityType` (the current page entity type) instead.

**Current behavior** (when on Jingle page selecting Cancion):

- `entityType = 'jingle'` (current page)
- `rel.entityType = 'cancion'` (selected entity)
- `startId = selectedEntity.id` (Cancion) ❌ **WRONG**
- `endId = entity.id` (Jingle) ❌ **WRONG**

**Expected behavior**:

- `startId = entity.id` (Jingle) ✅
- `endId = selectedEntity.id` (Cancion) ✅

**Why the query returns 0 entities**:

- The relationship is created as `(Cancion)-[VERSIONA]->(Jingle)`
- The refresh calls `fetchJingleCancion(jingleId)` which queries: `(j:Jingle {id: jingleId})-[:VERSIONA]->(c:Cancion)`
- This query doesn't match the created relationship (wrong direction)
- Result: `entitiesCount: 0`

**Comparison with other relationship types**:

- `tagged_with` (lines 646-661) correctly checks `entityType` to determine direction
- `appears_in` (lines 626-629) uses `rel.entityType` but the logic is correct for that relationship type
- `versiona` should follow the same pattern as `tagged_with` (always Jingle → Cancion)

## Resolution

**Status**: `resolved` - Fixed on 2025-11-18

**Fix Applied**:

Update the `versiona` relationship logic in `handleCreateRelationship` to always ensure Jingle is the start node and Cancion is the end node:

```typescript
} else if (relType === 'versiona') {
  // VERSIONA: (Jingle)-[VERSIONA]->(Cancion)
  // Jingle is always start, Cancion is always end
  if (entityType === 'jingle') {
    startId = entity.id; // Jingle (current entity)
    endId = selectedEntity.id; // Cancion (selected entity)
  } else if (entityType === 'cancion') {
    startId = selectedEntity.id; // Jingle (selected entity)
    endId = entity.id; // Cancion (current entity)
  } else {
    // Fallback (shouldn't happen, but just in case)
    startId = entity.id;
    endId = selectedEntity.id;
  }
}
```

This matches the pattern used for `tagged_with` relationships and ensures the relationship is always created in the correct direction.

**Fix Execution**:

- ✅ Code fix applied to `RelatedEntities.tsx` (see related commits)
- ✅ Existing incorrect relationships fixed via BUG_0007 audit and fix script
- ✅ Verified: All relationships now have correct direction
- ✅ Tested: Relationship creation works correctly from both Jingle and Cancion pages

**Data Fix**:

The incorrect `VERSIONA` relationship `(Cancion) c2idg5x12 -> (Jingle) jyzjddkg7` was identified and fixed by the BUG_0007 audit script on 2025-11-18. The relationship direction was corrected to `(Jingle) jyzjddkg7 -> (Cancion) c2idg5x12` with all properties preserved (status: "DRAFT").

## Related Files

- `frontend/src/components/common/RelatedEntities.tsx`

  - Search for: `} else if (relType === 'versiona') {`
  - Line ~630-633: Incorrect logic for determining startId/endId for versiona relationships
  - Line ~620: Relationship type determination
  - Line ~907: Refresh after relationship creation calls `fetchFn(entity.id, entityType)`
  - Line ~1312-1314: Similar logic in `getRelationshipProperties` (may need same fix)

- `frontend/src/lib/services/relationshipService.ts`

  - Search for: `fetchJingleCancion`
  - Line ~230-242: Function that queries for Cancion related to Jingle via VERSIONA
  - This function queries `(j:Jingle)-[:VERSIONA]->(c:Cancion)`, which is correct

- `frontend/src/lib/utils/relationshipConfigs.ts`

  - Search for: `fetchFn: (entityId: string, _entityType: string) => fetchJingleCancion(entityId)`
  - Line ~54: Configuration for Jingle → Cancion relationship

- `docs/adminRefactor/adminDetailedSpecification.md`
  - Search for: `VERSIONA` + `Relationship Direction Mapping`
  - Line ~1402: Specification states `VERSIONA: (Jingle)-[VERSIONA]->(Cancion)`

## Related Code

### Current Implementation (Buggy)

**RelatedEntities.tsx - handleCreateRelationship**:

```typescript
} else if (relType === 'versiona') {
  // Jingle -> Cancion
  startId = rel.entityType === 'cancion' ? selectedEntity.id : entity.id;
  endId = rel.entityType === 'cancion' ? entity.id : selectedEntity.id;
}
```

**Problem**: When on Jingle page selecting Cancion:

- `rel.entityType === 'cancion'` is true
- `startId = selectedEntity.id` (Cancion) ❌
- `endId = entity.id` (Jingle) ❌
- Creates: `(Cancion)-[VERSIONA]->(Jingle)` ❌

### Correct Implementation (Proposed)

```typescript
} else if (relType === 'versiona') {
  // VERSIONA: (Jingle)-[VERSIONA]->(Cancion)
  // Jingle is always start, Cancion is always end
  if (entityType === 'jingle') {
    startId = entity.id; // Jingle (current entity)
    endId = selectedEntity.id; // Cancion (selected entity)
  } else if (entityType === 'cancion') {
    startId = selectedEntity.id; // Jingle (selected entity)
    endId = entity.id; // Cancion (current entity)
  } else {
    // Fallback
    startId = entity.id;
    endId = selectedEntity.id;
  }
}
```

This ensures:

- When on Jingle page: Creates `(Jingle)-[VERSIONA]->(Cancion)` ✅
- When on Cancion page: Creates `(Jingle)-[VERSIONA]->(Cancion)` ✅
- Query `fetchJingleCancion(jingleId)` will find the relationship ✅

## Related Bugs

- **BUG_0005**: RelatedEntities false positive mismatch warning on page reload - **RESOLVED**
  - Both involve relationship loading/display issues, but BUG_0005 was about validation guards, while BUG_0006 is about relationship creation direction
