# BUG_0014 – REPEATS relationship creation fails with "Invalid time value" error

## Metadata

- **Status**: `in progress`
- **Last Updated**: 2025-11-26
- **Category**: `backend`
- **Severity**: `high`
- **Environment**: Admin interface, Chrome/Safari, API endpoint `/api/admin/relationships/repeats`
- **Related Commits / PRs**: TBD

## Reproduction Steps

1. Navigate to Admin Entity page for a Jingle (e.g., `/admin/j/[jingle-id]`)
2. Click "Editar" to enter Edit mode
3. Find the "Versiones" (REPEATS) relationship section
4. Click "Crear relacion" (Create relationship) or click on blank row
5. Select another Jingle to create REPEATS relationship with
6. **Expected**: The relationship should be created successfully
7. **Actual**: API returns 500 Internal Server Error with "Invalid time value" error

**Console Error**:

```
POST http://192.168.68.107/api/admin/relationships/repeats 500 (Internal Server Error)
[RelatedEntities] Error creating relationship: {error: Error: Invalid time value
    at http://192.168.68.107/assets/index-BcGHtR68.js:9:5782
    at async…, errorMessage: 'Invalid time value', relType: 'repeats', startId: 'j1acbu8xh', endId: 'j2h3phx33', …}
```

## Description

When creating a REPEATS relationship between two Jingles through the Admin interface, the API endpoint `/api/admin/relationships/repeats` returns a 500 Internal Server Error with the message "Invalid time value". This prevents REPEATS relationships from being created.

The error occurs during the direction validation process, which compares `fabricaDate` and `createdAt` values to determine the correct relationship direction.

**Key Observations**:

- Error occurs on backend during relationship creation
- Error message "Invalid time value" suggests a JavaScript Date parsing issue
- Affects REPEATS relationship creation specifically
- Similar to BUG_0010 (timestamp format issues), but occurs during relationship creation rather than display

## Expected Behavior

1. User creates REPEATS relationship via UI
2. Backend validates relationship direction based on `fabricaDate` and `createdAt`
3. Relationship is created in the database
4. API returns 201 Created with relationship data
5. UI refreshes and displays the related Jingle in the "Versiones" section

## Observed Behavior

1. User creates REPEATS relationship via UI
2. Backend attempts to validate relationship direction
3. Backend throws "Invalid time value" error when processing `createdAt` values
4. API returns 500 Internal Server Error
5. Relationship creation fails, no relationship is created
6. UI shows error message

## Root Cause

**Status**: `investigated` - Root cause identified

**Root Cause Identified**:

The issue is in `validateRepeatsDirection` function in `backend/src/server/db/validation/repeats-validation.ts`. The function does not handle null `createdAt` values from the database.

**The Problem**:

1. On lines 66-67, the code creates Date objects from `createdAt` values without checking for null:

   ```typescript
   const startCreatedAt = new Date(data.startCreatedAt);
   const endCreatedAt = new Date(data.endCreatedAt);
   ```

2. If either Jingle has a `null` or `undefined` `createdAt` value in the database, `new Date(null)` creates an invalid Date object.

3. When the code later calls `.toISOString()` on these invalid Date objects (lines 106, 111), it throws the "Invalid time value" error.

4. The type definition (lines 53, 56) declares `startCreatedAt: Date` and `endCreatedAt: Date`, but in reality these can be null in the database.

**Comparison with fabricaDate handling**:

- Lines 64-65 correctly handle null `fabricaDate` values: `data.startFabricaDate ? new Date(data.startFabricaDate) : null`
- Lines 66-67 do NOT handle null `createdAt` values, causing the error

**Why This Happens**:

- Some Jingles in the database may have null `createdAt` values (legacy data, import issues, etc.)
- The validation logic assumes `createdAt` is always present, but this assumption is incorrect
- When both Jingles are Inedito (no `fabricaDate`), the code falls back to comparing `createdAt` values (Rule 3), which fails if either is null

## Resolution

**Status**: `resolved` - Fixed on 2025-11-26

**Root Cause Confirmed**: `validateRepeatsDirection` was creating Date objects from `createdAt` values without checking for null, causing "Invalid time value" errors when calling `.toISOString()` on invalid Date objects.

**Fix Applied**:

Updated `validateRepeatsDirection` function in `backend/src/server/db/validation/repeats-validation.ts`:

1. **Updated type definition** (lines 50-57): Changed `startCreatedAt: Date` and `endCreatedAt: Date` to `Date | null` to reflect that these can be null in the database.

2. **Added null checks** (lines 66-67): Changed from:

   ```typescript
   const startCreatedAt = new Date(data.startCreatedAt);
   const endCreatedAt = new Date(data.endCreatedAt);
   ```

   to:

   ```typescript
   const startCreatedAt = data.startCreatedAt
     ? new Date(data.startCreatedAt)
     : null;
   const endCreatedAt = data.endCreatedAt ? new Date(data.endCreatedAt) : null;
   ```

3. **Added fallback logic for Rule 3** (lines 100-113): When both Jingles are Inedito and either `createdAt` is null, the function now:
   - Falls back to using the original direction (startId → endId)
   - Logs a descriptive reason message indicating that direction could not be determined due to missing `createdAt` values
   - Prevents the "Invalid time value" error

**Why This Works**:

- Matches the pattern used for `fabricaDate` handling (lines 64-65)
- Prevents invalid Date objects from being created
- Provides a safe fallback when `createdAt` is missing
- Maintains backward compatibility for Jingles with valid `createdAt` values

**Validation**:

- No linter errors introduced
- Type definitions updated to match database reality
- Fallback logic ensures relationship creation succeeds even with null `createdAt` values

**Testing Required**:

1. Test creating REPEATS relationship between two Jingles with null `createdAt` values
2. Test creating REPEATS relationship between two Jingles with valid `createdAt` values
3. Test all three direction validation rules (Both Published, One Inedito, Both Inedito)
4. Verify no "Invalid time value" errors in console

## Related Files

- `backend/src/server/db/validation/repeats-validation.ts`

  - Search for: `validateRepeatsDirection`
  - Line ~38-123: Function that validates REPEATS relationship direction
  - Line ~66-67: **BUG**: Creates Date objects from `createdAt` without null checks
  - Line ~101-113: Rule 3 (Both Inedito) that uses `createdAt` values - **fails if null**
  - Line ~106, 111: Calls `.toISOString()` on potentially invalid Date objects

- `backend/src/server/api/admin.ts`
  - Search for: `POST /relationships/:relType` or `validateRepeatsDirection`
  - Line ~824-978: Relationship creation endpoint
  - Line ~896: Calls `validateRepeatsDirection` for REPEATS relationships
  - Line ~878-929: REPEATS-specific validation logic

## Related Code

### Current Implementation (Buggy)

**repeats-validation.ts - validateRepeatsDirection (lines 66-67)**:

```typescript
// ❌ BUG: Does not handle null createdAt values
const startCreatedAt = new Date(data.startCreatedAt);
const endCreatedAt = new Date(data.endCreatedAt);
```

**Comparison with fabricaDate handling (lines 64-65)**:

```typescript
// ✅ CORRECT: Handles null fabricaDate values
const startFabricaDate = data.startFabricaDate
  ? new Date(data.startFabricaDate)
  : null;
const endFabricaDate = data.endFabricaDate
  ? new Date(data.endFabricaDate)
  : null;
```

**Rule 3 (Both Inedito) - lines 101-113**:

```typescript
// Rule 3: Both Inedito
else {
  if (startCreatedAt > endCreatedAt) {  // ❌ Fails if startCreatedAt or endCreatedAt is invalid Date
    // ...
    reason = `Both Inedito: Later (${startId}, ${startCreatedAt.toISOString()}) → Earlier (${endId}, ${endCreatedAt.toISOString()})`;  // ❌ Throws "Invalid time value"
  } else {
    // ...
    reason = `Both Inedito: Corrected direction - Later (${endId}, ${endCreatedAt.toISOString()}) → Earlier (${startId}, ${startCreatedAt.toISOString()})`;  // ❌ Throws "Invalid time value"
  }
}
```

## Related Bugs

- **BUG_0010**: Timestamps show 00:00:00 in Admin interface after bulk upload - **RESOLVED**

  - Similar timestamp/date handling issues, but in frontend display
  - Root cause was format mismatch (string vs number), not null handling

- **BUG_0011**: REPEATS relationship creation doesn't show entity after creation - **RESOLVED**

  - Different issue (schema validation), but also related to REPEATS relationships
  - This bug prevents creation entirely, while BUG_0011 was about display after creation

- **BUG_0012**: Tematica page doesn't show Jingles with null timestamps - **OPEN**
  - Similar null value handling issue, but for timestamps in relationship properties
  - This bug is for null `createdAt` on Jingle entities themselves

## Next Steps

1. **Fix null handling** in `validateRepeatsDirection`:

   - Add null checks for `createdAt` values
   - Provide fallback logic when `createdAt` is null
   - Update type definitions

2. **Test the fix**:

   - Test with Jingles that have null `createdAt` values
   - Test with Jingles that have valid `createdAt` values
   - Test all three direction validation rules

3. **Consider database migration**:
   - Check if there are many Jingles with null `createdAt` values
   - Consider adding a migration to set default `createdAt` values if needed
