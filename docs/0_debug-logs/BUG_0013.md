# BUG_0013 – Relationship deletion fails: Payload must include start and end ids to delete

## Metadata

- **Status**: `in progress`
- **Last Updated**: 2025-01-28
- **Category**: `frontend`
- **Severity**: `high`
- **Environment**: Browser (Chrome/Safari), localhost:5173, Admin area
- **Related Commits / PRs**: TBD

## Reproduction Steps

1. Navigate to an entity admin page (e.g., a Jingle, Fabrica, or other entity with relationships)
2. In the RelatedEntities component, click the X button to delete an existing relationship
3. Confirm the deletion in the modal
4. Observe the error message: "Error al eliminar la relación: Payload must include start and end ids to delete"
5. The relationship is not deleted

**Expected behavior**: When clicking the X button to delete a relationship, the deletion should succeed and the relationship should be removed from the UI.

**Actual behavior**: The deletion fails with a 400 Bad Request error because the API endpoint expects `start` and `end` IDs in the request body, but the frontend is sending them as query parameters.

## Description

When attempting to delete a relationship from the RelatedEntities component, the deletion fails with the error: "Error al eliminar la relación: Payload must include start and end ids to delete".

**Console Output**:

```
DELETE http://localhost:5173/api/admin/relationships/jinglero_de?start=a9qtaiil8&end=j28nwqyzo 400 (Bad Request)
Error deleting relationship: Error: Payload must include start and end ids to delete
```

The DELETE request is being sent with `start` and `end` as query parameters (`?start=...&end=...`), but the backend API endpoint expects these values in the request body.

## Root Cause

**Confirmed**: The `deleteRelationship` method in `frontend/src/lib/api/client.ts` (line 711-713) is sending the `start` and `end` IDs as query parameters in the URL:

```typescript
async deleteRelationship(relType: string, start: string, end: string): Promise<void> {
  return this.delete<void>(`/relationships/${relType}?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`);
}
```

However, the backend API endpoint (`backend/src/server/api/admin.ts`, line 1172-1177) expects these values in the request body:

```typescript
router.delete(
  "/relationships/:relType",
  asyncHandler(async (req, res) => {
    const { relType } = req.params;
    const payload = req.body || {};
    if (!payload.start || !payload.end) {
      throw new BadRequestError(
        "Payload must include start and end ids to delete"
      );
    }
    // ...
  })
);
```

The backend checks `req.body.start` and `req.body.end`, but since the frontend sends them as query parameters, `req.body` is empty, causing the validation to fail.

**Additional Issue**: The `delete` method in `AdminApiClient` (line 520-565) doesn't accept a body parameter, so we need to either:

1. Modify the `delete` method to accept an optional body parameter
2. Create a custom implementation for `deleteRelationship` that sends the body

## Resolution

**Status**: `in progress`

**Fix Applied**:

1. Modified the `delete` method in `AdminApiClient` to accept an optional `body` parameter
2. Updated `deleteRelationship` to send `start` and `end` in the request body instead of query parameters

**Code Changes**:

1. **frontend/src/lib/api/client.ts**:
   - Modified `delete` method signature to accept optional `body?: any` parameter
   - Updated `deleteRelationship` to send `{ start, end }` in the request body

**Validation Required**:

- Delete a relationship from RelatedEntities component - should succeed
- Verify the relationship is removed from the UI after deletion
- Check that no console errors appear
- Verify the DELETE request includes the body with `start` and `end` IDs
- Test with different relationship types (jinglero_de, appears_in, tagged_with, etc.)

## Related Files

- `frontend/src/lib/api/client.ts`
  - Search for: `async deleteRelationship`
  - Line ~711-713: `deleteRelationship` method - **needs fix**
  - Line ~520-565: `delete` method - **needs modification to accept body**
- `backend/src/server/api/admin.ts`

  - Search for: `router.delete('/relationships/:relType'`
  - Line ~1172-1230: DELETE relationship endpoint that expects body payload
  - Line ~1174-1176: Validation that checks `req.body.start` and `req.body.end`

- `frontend/src/components/common/RelatedEntities.tsx`
  - Search for: `handleConfirmDelete`
  - Line ~1236-1271: Handler that calls `adminApi.deleteRelationship`
  - Line ~1241: Where the delete API is called

## Related Code

### Current Implementation (Buggy)

**frontend/src/lib/api/client.ts**:

```typescript
async delete<T>(endpoint: string): Promise<T> {
  // ... sends DELETE request without body
}

async deleteRelationship(relType: string, start: string, end: string): Promise<void> {
  return this.delete<void>(`/relationships/${relType}?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`);
}
```

**Problem**: Query parameters are sent, but backend expects request body.

### Fixed Implementation

**frontend/src/lib/api/client.ts**:

```typescript
async delete<T>(endpoint: string, body?: any): Promise<T> {
  // ... sends DELETE request with optional body
  if (body) {
    headers['Content-Type'] = 'application/json';
    // ... include body in fetch options
  }
}

async deleteRelationship(relType: string, start: string, end: string): Promise<void> {
  return this.delete<void>(`/relationships/${relType}`, { start, end });
}
```

## Related Tests

- TBD: Add unit tests for `deleteRelationship` method
- TBD: Add integration tests for relationship deletion flow
