# BUG_0017 â€“ Search algorithm missing comentario and autoComment fields for Jingles

## Metadata

- **Status**: `open`
- **Last Updated**: 2025-12-05
- **Category**: `backend`, `search`
- **Severity**: `high`
- **Environment**: Backend search API, default search mode (basic)
- **Related Commits / PRs**: TBD

## Reproduction Steps

1. Navigate to search page: `/search?q=prima`
2. **Expected**: Jingle with id `j3nxigzo2` should appear in search results if the search term "prima" appears in its `comentario` (comment) or `autoComment` fields
3. **Actual**: Jingle `j3nxigzo2` does not appear in search results
4. The search term "prima" is present in either the `comment` or `autoComment` field of this Jingle, but these fields are not being searched

## Description

The search functionality for Jingles is incomplete. The current implementation only searches `title` and `songTitle` fields in basic mode (the default search mode). However, Jingles have two additional text fields that should be searchable:

1. **`comment`** (also referred to as `comentario` in some parts of the codebase): A user-provided comment field that may contain descriptive information about the Jingle
2. **`autoComment`**: A system-generated summary comment that was recently added to provide a concise overview of the jingle's core information (includes Fabrica date/timestamp, Title, Cancion, Autores, Primary Tematica, and Jingleros)

**Impact**: Users cannot find Jingles by searching for terms that appear only in the `comment` or `autoComment` fields, even though these fields contain relevant searchable content.

**Example**: Jingle `j3nxigzo2` contains the search term "prima" in either its `comment` or `autoComment` field, but does not appear in search results when searching for "prima" because these fields are not included in the search query.

## Root Cause

**Status**: `investigated` - Root cause identified

**Root Cause Identified**:

The search algorithm has incomplete field coverage for Jingles:

1. **Basic Mode Search (Default)**: In `backend/src/server/api/search.ts` (lines 178-179), the WHERE clause only searches:
   - `j.title`
   - `j.songTitle`
   
   Missing: `j.comment` and `j.autoComment`

2. **Public Search Endpoint**: In `backend/src/server/api/public.ts` (lines 1450-1451), the WHERE clause also only searches:
   - `j.title`
   - `j.songTitle`
   
   Missing: `j.comment` and `j.autoComment`

3. **Fulltext Mode**: The fulltext index in `backend/src/server/db/schema/setup.ts` (line 32) includes `j.comment` but NOT `j.autoComment`:
   - Current index: `[j.title, j.songTitle, j.artistName, j.comment]`
   - Missing: `j.autoComment`

**Evidence**:

- The `autoComment` field was recently added as part of the autoComment implementation (see `.cursor/plans/jingle-autocomment-implementation-b6b5222f.plan.md`)
- The `comment` field exists in the schema (`backend/src/server/db/schema/schema.ts` line 108) and is included in the fulltext index, but is NOT searched in basic mode
- The frontend search page (`frontend/src/pages/SearchResultsPage.tsx`) uses the default search endpoint which defaults to basic mode
- Documentation in `docs/5_backend_api-contracts/contracts/search-api.md` (lines 163-175) lists the searched fields and confirms `comment` is only searched in fulltext mode, not basic mode

**Field Name Clarification**:
- Database field name: `comment` (not `comentario`)
- TypeScript interface: `comment?: string` (see `backend/src/server/db/types.ts` line 62)
- Some cleanup scripts and comments refer to it as `comentario` (Spanish), but the actual database property is `comment` (English)

## Resolution

**Status**: `pending` - Awaiting approval

**Resolution Approach**: Add `comment` and `autoComment` fields to Jingle search queries

**Implementation Plan**:

1. **Update Basic Mode Search** (`backend/src/server/api/search.ts`):
   - Add `j.comment` to WHERE clause (lines 178-179)
   - Add `j.autoComment` to WHERE clause
   - Ensure null/empty checks are consistent with existing pattern

2. **Update Public Search Endpoint** (`backend/src/server/api/public.ts`):
   - Add `j.comment` to WHERE clause (lines 1450-1451)
   - Add `j.autoComment` to WHERE clause
   - Ensure null/empty checks are consistent with existing pattern

3. **Update Fulltext Index** (`backend/src/server/db/schema/setup.ts`):
   - Add `j.autoComment` to the fulltext index (line 32)
   - Update both `jingle_search` and `clip_search` indexes (lines 32 and 38)

4. **Update Documentation** (`docs/5_backend_api-contracts/contracts/search-api.md`):
   - Update Basic Mode section to list `comment` and `autoComment` as searched fields
   - Update Fulltext Mode section to list `autoComment` as indexed field

**Files to Change**:

- `backend/src/server/api/search.ts`: Add `comment` and `autoComment` to basic mode WHERE clause
- `backend/src/server/api/public.ts`: Add `comment` and `autoComment` to public search WHERE clause
- `backend/src/server/db/schema/setup.ts`: Add `autoComment` to fulltext indexes
- `docs/5_backend_api-contracts/contracts/search-api.md`: Update documentation

**Note**: The fulltext index update will require a database migration or manual index recreation. The index can be dropped and recreated, or a new index can be created with the additional field.

## Related Files

- `backend/src/server/api/search.ts`: Search for `WHERE ${whereClause}` - Line ~178-179: Basic mode search WHERE clause for Jingles (only searches title and songTitle)
  - **Issue**: Missing `j.comment` and `j.autoComment` in WHERE clause
  - **Location**: Jingle search query construction (lines 176-196)
- `backend/src/server/api/public.ts`: Search for `WHERE toLower(coalesce(j.title` - Line ~1450-1451: Public search endpoint WHERE clause for Jingles
  - **Issue**: Missing `j.comment` and `j.autoComment` in WHERE clause
  - **Location**: Public search jingles query (lines 1448-1463)
- `backend/src/server/db/schema/setup.ts`: Search for `CREATE FULLTEXT INDEX jingle_search` - Line ~32: Fulltext index definition
  - **Issue**: Index includes `j.comment` but NOT `j.autoComment`
  - **Location**: Index creation (lines 30-49)
- `docs/5_backend_api-contracts/contracts/search-api.md`: Search for `Basic Mode` - Line ~159-168: Documentation of searched fields
  - **Issue**: Documentation doesn't list `comment` or `autoComment` as searched fields in basic mode
  - **Location**: Search behavior documentation (lines 151-195)
- `frontend/src/pages/SearchResultsPage.tsx`: Search for `api.get('/search?q='` - Line ~52: Frontend search page that uses default (basic) mode
  - **Note**: Uses default search endpoint which defaults to basic mode
- `backend/src/server/db/types.ts`: Search for `comment?: string` - Line ~62: Type definition for comment field
- `backend/src/server/db/types.ts`: Search for `autoComment?: string` - Line ~79: Type definition for autoComment field

## Related Code

### Basic Mode Search Query (Incomplete)

**search.ts - Basic mode Jingle search**:

```cypher
WHERE (j.title IS NOT NULL AND j.title <> '' AND toLower(j.title) CONTAINS $text)
   OR (j.songTitle IS NOT NULL AND j.songTitle <> '' AND toLower(j.songTitle) CONTAINS $text)
```

**Missing**: `j.comment` and `j.autoComment` conditions

### Public Search Query (Incomplete)

**public.ts - Public search Jingle query**:

```cypher
WHERE toLower(coalesce(j.title, '')) CONTAINS $text
   OR toLower(coalesce(j.songTitle, '')) CONTAINS $text
```

**Missing**: `j.comment` and `j.autoComment` conditions

### Fulltext Index (Incomplete)

**setup.ts - Fulltext index definition**:

```cypher
CREATE FULLTEXT INDEX jingle_search IF NOT EXISTS 
FOR (j:Jingle) ON EACH [j.title, j.songTitle, j.artistName, j.comment]
```

**Missing**: `j.autoComment` in the index

### Expected Complete Query (Proposed Fix)

**Basic mode should include**:

```cypher
WHERE (j.title IS NOT NULL AND j.title <> '' AND toLower(j.title) CONTAINS $text)
   OR (j.songTitle IS NOT NULL AND j.songTitle <> '' AND toLower(j.songTitle) CONTAINS $text)
   OR (j.comment IS NOT NULL AND j.comment <> '' AND toLower(j.comment) CONTAINS $text)
   OR (j.autoComment IS NOT NULL AND j.autoComment <> '' AND toLower(j.autoComment) CONTAINS $text)
```

**Fulltext index should include**:

```cypher
CREATE FULLTEXT INDEX jingle_search IF NOT EXISTS 
FOR (j:Jingle) ON EACH [j.title, j.songTitle, j.artistName, j.comment, j.autoComment]
```

## Related tests

TBD - Need to identify or create tests for search functionality

**Test Cases to Add**:

1. Test that Jingle with search term in `comment` field appears in basic mode search results
2. Test that Jingle with search term in `autoComment` field appears in basic mode search results
3. Test that Jingle with search term in `autoComment` field appears in fulltext mode search results
4. Test that public search endpoint includes `comment` and `autoComment` in results

